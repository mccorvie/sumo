---
title: "üéå Elo on the Dohy≈ç üéå"
author: "Ryan McCorvie"
format: 
  html:
    page-layout: full
    include-after-body: 
      file: googletag.html
editor: visual
---

```{r}
#| echo: false
#| output: false

library(tidyverse)
library(plotly)
library(gt)
library(DT)
source( "sumo_api.R" )
source( "elo_functions.R")

basho_id = current_basho()
matches_cache <- readRDS( "matches_cache.Rdata")
elo_history   <- readRDS( "elo_history.Rdata")
sumo_name_t   <- readRDS( "sumo_name_t.Rdata")
#all_rikishi() |> select( rikishiId = id, shikona = shikonaEn )

day <- 9

```


Welcome to the rikishi Elo scoreboard! This page gives you a quick way to see who‚Äôs looking strongest in the current basho.

![](elo_dohyo.png){fig-align="center" width=60%}

## Sumo Strength by the Numbers

Each wrestler has an Elo rating, which goes up when they win and down when they lose, so the numbers shift day by day as the action unfolds.

Match odds are based on the gap between two wrestlers‚Äô scores ‚Äî a big difference means there‚Äôs a clear favorite, while a closer spread means we could be in for a real battle.

If you‚Äôd like to dive into the math behind it all, check out the [Elo model details](sumo_elo.html)


## Elo Trends for `r basho_description(basho_id)`

```{r}
#| echo: false
#| fig-align: center
#| out-height: auto

banzuke_rank <- basho_sumo_rank( basho_id ) |>
  filter( rank_name != "Jonokuchi", rank_name != "Jonidan", rank_name != "Sandanme", rank_name != "Makushita", rank_name != "Juryo" )


banzuke_elo <- banzuke_rank |> left_join( elo_as_of( basho_id, 1 ), by="rikishiId" ) |>
  mutate( elo = coalesce( elo, 1500), ordinal_rank = 1:n())  |>
select( -rank ) |> 
  rename( pre_tournament_elo = elo, rank=rank_name ) |>
  left_join( elo_as_of( basho_id, day ), by="rikishiId" ) |>
  left_join( sumo_name_t, by="rikishiId" )


pp<- ggplot( banzuke_elo, aes( ordinal_rank, elo, color=rank, text=shikona)) +
  geom_segment( aes( x=ordinal_rank, y=pre_tournament_elo, xend=ordinal_rank, yend = elo), arrow=arrow(length=unit(0.15, "inches"))) +
  geom_point(size=1.5) +
  scale_color_brewer( palette ="Set2") +
  labs( title = paste0("Elo Movement" )) +
  xlab("banzuke rank")

ggplotly(pp, tooltip = "text", width=800 ) |> 
  layout(
    legend = list(
      orientation = "h",     # horizontal
      x = 0.5,               # center horizontally
      xanchor = "center",
      y = -0.2               # move below the plot
  )) 

```




## Today‚Äôs Rikishi Power Meter

###  Head-to-Head Odds - Day `r day`

```{r}
#| echo: false
#| fig-height: 10

match_sheet <- get_match_sheet( basho_id,  day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Elo Gap`    = paste( round(elo_mismatch), ifelse( elo_east>=elo_west, "‚Üê","‚Üí")),
    `Headshot E` = paste0( "sumo_headshots/", eastShikona, ".jpg"),
    `Headshot W` = paste0( "sumo_headshots/", westShikona, ".jpg")
  ) 

prediction_sheet <- match_sheet |> 
  select( `Match` = matchNo, `Headshot E`, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E`=pwin_east, `Odds E`=odds_east, `Elo Gap`,  `Odds W` = odds_west, `Win Prob W` = pwin_west, `Elo W` = elo_west,`Record W` = record_west,  West = westShikona, `Headshot W` )


gt( prediction_sheet) |>
  text_transform(
    locations = cells_body(columns = c(`Headshot E`, `Headshot W`)),
    fn = \(x) local_image( filename = x, height = 40)
  ) |> 
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "15px") |> 
  fmt_number(
    columns = c(`Elo E`, `Elo W`, `Elo Gap` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( `Win Prob E`, `Odds E`,  `Win Prob W`, `Odds W` ),
    decimals = 2
  ) |> 
  cols_align(
    align = "right",
    columns = `Elo Gap`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Odds E`, `Elo Gap` )
    )
  )

```


## Day-by-day Review for `r basho_description(basho_id)`

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```


### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```

### Match Recap - Day `r day=day-1` `r day` 

```{r}
#| echo: false

match_sheet <- get_match_sheet( basho_id, day )

match_sheet <- match_sheet |> 
  mutate( 
    record_east = paste0( wins_east, "-", losses_east),
    record_west = paste0( wins_west, "-", losses_west),
    `Win` = ifelse( eastShikona == winnerEn, "‚Üê","‚Üí"),
  ) 

post_sheet <- match_sheet |> 
select( `Match` = matchNo, East = eastShikona, `Record E` = record_east, `Elo E` = elo_east, `Win Prob E` = pwin_east, Win,  West = westShikona, `Record W` = record_west,  `Elo W` = elo_west, `Win Prob W` = pwin_west, Surprisal = surprisal)


gt( post_sheet) |>
  tab_options(table.width = pct(90)) |> 
  tab_options(table.font.size = "14px") |> 
  fmt_number(
    columns = c( `Elo W`, `Elo E` ),
    use_seps = F,
    decimals = 0  # sets the number of decimal places
  ) |> 
  fmt_number(
    columns =  c( Surprisal, `Win Prob E`, `Win Prob W`),
    decimals = 2
  ) |> 
  cols_align(
    align = "center",
    columns = `Win`   # replace with your column
  ) |> 
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "black",
      weight = px(2)
    ),
    locations = cells_body(
      columns = c( `Win Prob E`, `Win`, `Win Prob W` )
    )
  )

```


